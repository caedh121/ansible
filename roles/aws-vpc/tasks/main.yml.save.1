---
# tasks file for roles/aws-vpc

- name: create VPC
  ec2_vpc_net:
    name: "{{ vpc_name }}"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
    state: present
#  tags:
#    Customer: "{{customer}}"
#    Environment: "{{development}}"
#    Project: "{{project}}"
#    IsPublic: "{{ispublic}}"
#    Createdby: "{{createdby}}"
  register: thisvpc
  when: (vpc_cidr is defined) and (region is defined)

- name: Create Subnets
  ec2_vpc_subnet:
    state: present
    region: "{{ region }}"
    vpc_id: "{{ thisvpc.vpc.id }}"
    cidr: "{{ item.subnet_cidr }}"
    az: "{{ item.subnet_az }}"
    map_public: "{{ item.ispublic | default ('no') }}"
    resource_tags:
      Name: "{{ item.subnet_name }}"
      VPCname: "{{ vpc_name }}"
      Customer: "{{customer}}"
      Createdby: "{{createdby}}"
      IsPublic: "{{ item.ispublic | default ('no') }}"
  with_items: "{{subnet}}"
  register: subnets_output

- name: "Ansible | Print a variable"
  debug:
    msg:  "{{subnets_output.results.subnet.id}}"

- name: Create Internet Gateway
  ec2_vpc_igw:
   vpc_id: "{{ thisvpc.vpc.id }}"
   region: "{{ region }}"
   state: present
   tags:
     Name: "{{ igw_name }}"
  register: thisigw

- name: Route IGW
  ec2_vpc_route_table:
    vpc_id: "{{ thisvpc.vpc.id }}"
    region: "{{ region }}"
    state: present
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ thisigw.gateway_id }}"

- name: Create NAT Gateway
  ec2_vpc_nat_gateway:
    state: present
    subnet_id: "{{ subnet.id }}"
    region: "{{ region }}"
  register: thisnatgw

- name: Route NAT
  ec2_vpc_route_table:
    vpc_id: "{{ thisvpc.vpc.id }}"
    region: "{{ region }}"
    state: present
   routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ thisnatgw.gateway_id }}"
 
- name: Create MyOrg Default Security Group
  ec2_group:
    name: default
    description: MyOrg default ports
    vpc_id: "{{ thisvpc.vpc.id }}"
    region: "{{ region }}"
    rules:
      - proto: tcp
        ports:
        - 443
        cidr_ip: 172.20.0.0/16
        rule_desc: https from london ras 
      - proto: tcp
        ports:
        - 22
        cidr_ip: 172.20.0.0/16
        rule_desc: ssh from london ras 
      - proto: tcp
        ports:
        - 22
        cidr_ip: 172.21.1.0/24
        rule_desc: ssh from sao paolo ras 
      - proto: tcp
        ports:
        - 9100
        - 9101
        cidr_ip: 172.20.0.0/16
        rule_desc: prometheus scrape 
      - proto: tcp
        ports:
        - 4567
        cidr_ip: 172.20.0.0/16
        rule_desc: Webmon from london ras 
      - proto: icmp
        ports:
        - -1
        cidr_ip: 172.20.0.0/16
        rule_desc: ping from london ras 
  register: thissg
